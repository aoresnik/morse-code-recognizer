<!DOCTYPE html>

<!-- Shows an indicator when any key is pressed. Planned as a basis for morse code typing parser. -->

<html>

<head>
    <style media="screen" type="text/css">
        * {
            margin: 0;
            padding: 0;
        }

        /* to remove the top and left whitespace */

        html,
        body {
            width: 100%;
            height: 100%;
        }

        /* just to be sure these are full screen*/

        canvas {
            display: block;
        }

        /* To remove the scrollbars */
    </style>
    <script type="text/javascript">
        // based on https://www.html5canvastutorials.com/advanced/html5-canvas-animation-stage/

        // FIXME: the ball speed is dependent on the display DPI and frame rate, should be constant

        function main() {
            window.requestAnimFrame = (function(callback) {
                return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
                    function(callback) {
                        window.setTimeout(callback, 1000 / 60);
                    };
            })();

            function updateIndicator() {
                context.beginPath();
                context.ellipse(canvas.width / 2, canvas.height / 2, 50, 50, 0, 0, 2 * Math.PI);;
                context.fillStyle = pressState ? 'red' : 'black';
                context.fill();
                context.lineWidth = 1;
                context.strokeStyle = 'black';
                context.stroke();
            }

            function keydown(e) {
                e = e || window.event;
                if (!pressState) {
                    // Only if not pressed
                    const t = (new Date()).getTime()
                    console.log("Key pressed at " + t);
                    pressState = true;
                    dashes.push({start:t, end:null});
                    updateIndicator();
                }
            }

            function keyup(e) {
                e = e || window.event;
                const t = (new Date()).getTime()
                console.log("Key released at " + t);
                pressState = false;
                updateIndicator();
                dashes[dashes.length-1].end = t;
            }

            document.onkeydown = keydown;
            document.onkeyup = keyup;

            function animate(canvas, context, startTime) {
                indicatorY = canvas.height / 2 + 60;
                indicatorH = 10
                context.clearRect(0, indicatorY, canvas.width, indicatorH);

                function barX(t)
                {
                    return canvas.width/2 - ((new Date()).getTime()-t) / 10;
                }

                context.fillStyle = 'black';
                let i = dashes.length-1;
                while (i >= 0)
                {
                    const x0 = barX(dashes[i].start);
                    const x1 = dashes[i].end ? barX(dashes[i].end) : canvas.width/2;
                    //console.log("Drawing bar from " + x0 + "-" + x1);
                    context.fillRect(x0, indicatorY, x1-x0, indicatorH);
                    i--;
                }

                // request new frame
                requestAnimFrame(function() {
                        animate(canvas, context, startTime);
                });
            }

            var canvas = document.getElementById('canvas0');
            var context = canvas.getContext('2d');
            var pressState = false;
            var dashes = [];

            // resize the canvas to fill browser window dynamically
            window.addEventListener('resize', resizeCanvas, false);

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            updateIndicator();

            // wait one second before starting animation
            setTimeout(function() {
                    var startTime = (new Date()).getTime();
                    animate(canvas, context, startTime);
            }, 1000);
        }
    </script>
</head>

<body onload="main()">
    <canvas id="canvas0"></canvas>

</html>
</body>
